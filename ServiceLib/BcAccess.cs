using System;
using System.Linq;
using Renci.SshNet;
using ServiceLib.Contracts;
using ServiceLib.Contracts.BlockChainExchangeService;

namespace BlockChain.Integration
{
    public class BcAccess : IBlockChainExchangeService
    {

        //string account1 = "0xa2081622fcc99aec3c1efb575b548c90bdadf8cf";
        //string account2 = "0x052125e58ee311993185419d9323d4092fddc656";

        string userName = "deathys";
        string pass = "XSW@zaq1";

        //string gethUrl = "http://localhost:8545";
        string hostUrl = "13.76.171.171";

        string creatorAddress = "0xe5855503e18317cfc775cf899f415ae60bce7189";
        //string creatorAbiDefinition = "[{\"constant\":false,\"inputs\":[{\"name\":\"x\",\"type\":\"address\"}],\"name\":\"toString\",\"outputs\":[{\"name\":\"\",\"type\":\"string\"}],\"payable\":false,\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"response\",\"outputs\":[{\"name\":\"\",\"type\":\"bytes\"}],\"payable\":false,\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"name\":\"id\",\"type\":\"uint256\"},{\"name\":\"_response\",\"type\":\"bytes\"}],\"name\":\"__tinyOracleCallback\",\"outputs\":[],\"payable\":false,\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"name\":\"acc\",\"type\":\"address\"},{\"name\":\"balance\",\"type\":\"uint256\"}],\"name\":\"addAccount\",\"outputs\":[{\"name\":\"balance2\",\"type\":\"uint256\"}],\"payable\":false,\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"name\":\"receiver\",\"type\":\"address\"},{\"name\":\"amount\",\"type\":\"uint256\"},{\"name\":\"callbackUrl\",\"type\":\"string\"}],\"name\":\"sendCoin\",\"outputs\":[{\"name\":\"sufficient\",\"type\":\"bool\"}],\"payable\":false,\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"name\":\"query\",\"type\":\"bytes\"}],\"name\":\"query\",\"outputs\":[],\"payable\":false,\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"name\":\"acc\",\"type\":\"address\"}],\"name\":\"getAccount\",\"outputs\":[{\"name\":\"balance\",\"type\":\"uint256\"}],\"payable\":false,\"type\":\"function\"},{\"inputs\":[],\"type\":\"constructor\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"name\":\"sender\",\"type\":\"address\"},{\"indexed\":false,\"name\":\"receiver\",\"type\":\"address\"},{\"indexed\":false,\"name\":\"amount\",\"type\":\"uint256\"}],\"name\":\"CoinTransfer\",\"type\":\"event\"}]";
        string trackerAbiDefinition = @"[{""constant"":false,""inputs"":[],""name"":""CloseCreditDeal"",""outputs"":[],""payable"":false,""type"":""function""},{""constant"":false,""inputs"":[{""name"":""x"",""type"":""address""}],""name"":""toAsciiString"",""outputs"":[{""name"":"""",""type"":""string""}],""payable"":false,""type"":""function""},{""constant"":false,""inputs"":[{""name"":""x"",""type"":""address""}],""name"":""toString"",""outputs"":[{""name"":"""",""type"":""string""}],""payable"":false,""type"":""function""},{""constant"":false,""inputs"":[{""name"":""b"",""type"":""bytes1""}],""name"":""char"",""outputs"":[{""name"":""c"",""type"":""bytes1""}],""payable"":false,""type"":""function""},{""constant"":true,""inputs"":[],""name"":""response"",""outputs"":[{""name"":"""",""type"":""bytes""}],""payable"":false,""type"":""function""},{""constant"":false,""inputs"":[{""name"":""id"",""type"":""uint256""},{""name"":""_response"",""type"":""bytes""}],""name"":""__tinyOracleCallback"",""outputs"":[],""payable"":false,""type"":""function""},{""constant"":false,""inputs"":[{""name"":""query"",""type"":""bytes""}],""name"":""query"",""outputs"":[],""payable"":false,""type"":""function""},{""constant"":false,""inputs"":[],""name"":""test"",""outputs"":[{""name"":""data"",""type"":""string""}],""payable"":false,""type"":""function""},{""inputs"":[{""name"":""urlSender"",""type"":""string""},{""name"":""urlReceiver"",""type"":""string""},{""name"":""txid"",""type"":""string""},{""name"":""json"",""type"":""string""}],""payable"":false,""type"":""constructor""},{""anonymous"":false,""inputs"":[{""indexed"":false,""name"":""senderUrl"",""type"":""string""},{""indexed"":false,""name"":""reveiverUrl"",""type"":""string""},{""indexed"":false,""name"":""txid"",""type"":""string""},{""indexed"":false,""name"":""receiver"",""type"":""address""}],""name"":""Closed"",""type"":""event""}]";
        string trackerByteCode = "60606040523462000000576040516200202e3803806200202e833981016040528080518201919060200180518201919060200180518201919060200180518201919060200150505b8360009080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106200009557805160ff1916838001178555620000c6565b82800160010185558215620000c6579182015b82811115620000c5578251825591602001919060010190620000a8565b5b509050620000ee91905b80821115620000ea576000816000905550600101620000d0565b5090565b50508160029080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106200013e57805160ff19168380011785556200016f565b828001600101855582156200016f579182015b828111156200016e57825182559160200191906001019062000151565b5b5090506200019791905b808211156200019357600081600090555060010162000179565b5090565b50508260019080519060200190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10620001e757805160ff191683800117855562000218565b8280016001018555821562000218579182015b8281111562000217578251825591602001919060010190620001fa565b5b5090506200024091905b808211156200023c57600081600090555060010162000222565b5090565b50506200036d620003538562000339604060405190810160405280601281526020017f2f646f63637265617465643f646f6369643d00000000000000000000000000008152602001506200031f8762000305604060405190810160405280601181526020017f267472616e73616374696f6e616464723d000000000000000000000000000000815260200150620002eb32620004a56401000000000262000806176401000000009004565b620006f964010000000002620010f9176401000000009004565b620006f964010000000002620010f9176401000000009004565b620006f964010000000002620010f9176401000000009004565b620006f964010000000002620010f9176401000000009004565b62000916640100000000026200130d176401000000009004565b50620004996200047f8462000465604060405190810160405280601f81526020017f2f646f6372656365697665643f736d617274636f6e7472616374616464723d008152602001506200044b620003d830620004a56401000000000262000806176401000000009004565b62000431604060405190810160405280601081526020017f26646f635f73657269616c697a65643d0000000000000000000000000000000081526020015089620006f964010000000002620010f9176401000000009004565b620006f964010000000002620010f9176401000000009004565b620006f964010000000002620010f9176401000000009004565b620006f964010000000002620010f9176401000000009004565b62000916640100000000026200130d176401000000009004565b505b5050505062000b95565b6020604051908101604052806000815260200150602060405190810160405280600081526020015060006000600060006028604051805910620004e55750595b908082528060200260200182016040528015505b509450600093505b6014841015620006eb578360130360080260020a8773ffffffffffffffffffffffffffffffffffffffff1681156200000057047f01000000000000000000000000000000000000000000000000000000000000000292506010837f0100000000000000000000000000000000000000000000000000000000000000900460ff1681156200000057047f0100000000000000000000000000000000000000000000000000000000000000029150817f01000000000000000000000000000000000000000000000000000000000000009004601002837f01000000000000000000000000000000000000000000000000000000000000009004037f01000000000000000000000000000000000000000000000000000000000000000290506200063c8262000a986401000000000262000b23176401000000009004565b8585600202815181101562000000579060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a9053506200069a8162000a986401000000000262000b23176401000000009004565b8560018660020201815181101562000000579060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a9053505b838060010194505062000501565b8495505b5050505050919050565b602060405190810160405280600081526020015060206040519081016040528060008152602001506020604051908101604052806000815260200150602060405190810160405280600081526020015060206040519081016040528060008152602001506000600088955087945084518651016040518059106200077a5750595b908082528060200260200182016040528015505b50935083925060009150600090505b85518110156200084f578581815181101562000000579060200101517f010000000000000000000000000000000000000000000000000000000000000090047f0100000000000000000000000000000000000000000000000000000000000000028383806001019450815181101562000000579060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a9053505b80806001019150506200079d565b600090505b845181101562000906578481815181101562000000579060200101517f010000000000000000000000000000000000000000000000000000000000000090047f0100000000000000000000000000000000000000000000000000000000000000028383806001019450815181101562000000579060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a9053505b808060010191505062000854565b8296505b50505050505092915050565b600060006000731141d57ea99b8a8ce5faf18774d6dbb56deffc2891508173ffffffffffffffffffffffffffffffffffffffff1663321db4d4600060405160200152604051817c0100000000000000000000000000000000000000000000000000000000028152600401809050602060405180830381600087803b15620000005760325a03f11562000000575050506040518051906020015090508073ffffffffffffffffffffffffffffffffffffffff1663ed815d8385600060405160200152604051827c010000000000000000000000000000000000000000000000000000000002815260040180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f16801562000a5d5780820380516001836020036101000a031916815260200191505b5092505050602060405180830381600087803b15620000005760325a03f11562000000575050506040518051906020015092505b5050919050565b6000600a7f010000000000000000000000000000000000000000000000000000000000000002827effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916101562000b3e576030827f01000000000000000000000000000000000000000000000000000000000000009004017f010000000000000000000000000000000000000000000000000000000000000002905062000b905662000b8f565b6057827f01000000000000000000000000000000000000000000000000000000000000009004017f010000000000000000000000000000000000000000000000000000000000000002905062000b90565b5b919050565b61148a8062000ba46000396000f360606040523615610086576000357c01000000000000000000000000000000000000000000000000000000009004806309c3b3241461008b5780632c6e75981461009a57806356ca623e1461012357806369f9ad2f146101ac5780637a7f01a7146101ff578063b29f731d1461027a578063ed815d83146102ab578063f8a8fd6d14610302575b610000565b346100005761009861037d565b005b34610000576100b56004808035906020019091905050610806565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f1680156101155780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b346100005761013e6004808035906020019091905050610a27565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f16801561019e5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34610000576101c76004808035906020019091905050610b23565b60405180827effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916815260200191505060405180910390f35b346100005761020c610c1c565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f16801561026c5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b34610000576102a960048080359060200190919080359060200190820180359060200191909192905050610cba565b005b3461000057610300600480803590602001908201803590602001908080601f01602080910402602001604051908101604052809392919081815260200183838082843782019150505050505091905050610e2a565b005b346100005761030f610e38565b60405180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f16801561036f5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b7fea7d4245046c9cd8ea6abe8b2d9e1486f71e4daf7da0306b0a6db158291501d860006001600233604051808060200180602001806020018573ffffffffffffffffffffffffffffffffffffffff1681526020018481038452888181546001816001161561010002031660029004815260200191508054600181600116156101000203166002900480156104525780601f1061042757610100808354040283529160200191610452565b820191906000526020600020905b81548152906001019060200180831161043557829003601f168201915b50508481038352878181546001816001161561010002031660029004815260200191508054600181600116156101000203166002900480156104d55780601f106104aa576101008083540402835291602001916104d5565b820191906000526020600020905b8154815290600101906020018083116104b857829003601f168201915b50508481038252868181546001816001161561010002031660029004815260200191508054600181600116156101000203166002900480156105585780601f1061052d57610100808354040283529160200191610558565b820191906000526020600020905b81548152906001019060200180831161053b57829003601f168201915b505097505050505050505060405180910390a16106f36106ee60008054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156106075780601f106105dc57610100808354040283529160200191610607565b820191906000526020600020905b8154815290600101906020018083116105ea57829003601f168201915b50505050506106e9604060405190810160405280601281526020017f2f6465616c636c6f7365643f646f6369643d000000000000000000000000000081526020015060028054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156106df5780601f106106b4576101008083540402835291602001916106df565b820191906000526020600020905b8154815290600101906020018083116106c257829003601f168201915b50505050506110f9565b6110f9565b61130d565b506107ea6107e560018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156107905780601f1061076557610100808354040283529160200191610790565b820191906000526020600020905b81548152906001019060200180831161077357829003601f168201915b50505050506107e0604060405190810160405280601d81526020017f2f646f63636c6f7365643f736d617274636f6e7472616374616464723d0000008152602001506107db30610806565b6110f9565b6110f9565b61130d565b503073ffffffffffffffffffffffffffffffffffffffff16ff5b565b60206040519081016040528060008152602001506020604051908101604052806000815260200150600060006000600060286040518059106108455750595b908082528060200260200182016040528015505b509450600093505b6014841015610a19578360130360080260020a8773ffffffffffffffffffffffffffffffffffffffff16811561000057047f01000000000000000000000000000000000000000000000000000000000000000292506010837f0100000000000000000000000000000000000000000000000000000000000000900460ff16811561000057047f0100000000000000000000000000000000000000000000000000000000000000029150817f01000000000000000000000000000000000000000000000000000000000000009004601002837f01000000000000000000000000000000000000000000000000000000000000009004037f010000000000000000000000000000000000000000000000000000000000000002905061098382610b23565b85856002028151811015610000579060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a9053506109ca81610b23565b85600186600202018151811015610000579060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a9053505b8380600101945050610861565b8495505b5050505050919050565b6020604051908101604052806000815260200150602060405190810160405280600081526020015060006014604051805910610a605750595b908082528060200260200182016040528015505b509150600090505b6014811015610b18578060130360080260020a8473ffffffffffffffffffffffffffffffffffffffff16811561000057047f01000000000000000000000000000000000000000000000000000000000000000282828151811015610000579060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a9053505b8080600101915050610a7c565b8192505b5050919050565b6000600a7f010000000000000000000000000000000000000000000000000000000000000002827effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff19161015610bc6576030827f01000000000000000000000000000000000000000000000000000000000000009004017f0100000000000000000000000000000000000000000000000000000000000000029050610c1756610c16565b6057827f01000000000000000000000000000000000000000000000000000000000000009004017f0100000000000000000000000000000000000000000000000000000000000000029050610c17565b5b919050565b60038054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610cb25780601f10610c8757610100808354040283529160200191610cb2565b820191906000526020600020905b815481529060010190602001808311610c9557829003601f168201915b505050505081565b6000731141d57ea99b8a8ce5faf18774d6dbb56deffc2890508073ffffffffffffffffffffffffffffffffffffffff16637e9ba301600060405160200152604051817c0100000000000000000000000000000000000000000000000000000000028152600401809050602060405180830381600087803b156100005760325a03f115610000575050506040518051906020015073ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16141515610d8657610000565b828260039190828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610dcd57803560ff1916838001178555610dfb565b82800160010185558215610dfb579182015b82811115610dfa578235825591602001919060010190610ddf565b5b509050610e2091905b80821115610e1c576000816000905550600101610e04565b5090565b50505b5b50505050565b610e338161130d565b505b50565b60206040519081016040528060008152602001506110f3604060405190810160405280600a81526020017f73656e64657255726c3a000000000000000000000000000000000000000000008152602001506110ee60008054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610f225780601f10610ef757610100808354040283529160200191610f22565b820191906000526020600020905b815481529060010190602001808311610f0557829003601f168201915b50505050506110e9604060405190810160405280600d81526020017f3b726563656976657255726c3a000000000000000000000000000000000000008152602001506110e460018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610ffd5780601f10610fd257610100808354040283529160200191610ffd565b820191906000526020600020905b815481529060010190602001808311610fe057829003601f168201915b50505050506110df604060405190810160405280600f81526020017f3b7472616e73616374696f6e49643a000000000000000000000000000000000081526020015060028054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156110d55780601f106110aa576101008083540402835291602001916110d5565b820191906000526020600020905b8154815290600101906020018083116110b857829003601f168201915b50505050506110f9565b6110f9565b6110f9565b6110f9565b6110f9565b90505b90565b602060405190810160405280600081526020015060206040519081016040528060008152602001506020604051908101604052806000815260200150602060405190810160405280600081526020015060206040519081016040528060008152602001506000600088955087945084518651016040518059106111795750595b908082528060200260200182016040528015505b50935083925060009150600090505b855181101561124a5785818151811015610000579060200101517f010000000000000000000000000000000000000000000000000000000000000090047f01000000000000000000000000000000000000000000000000000000000000000283838060010194508151811015610000579060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a9053505b808060010191505061119c565b600090505b84518110156112fd5784818151811015610000579060200101517f010000000000000000000000000000000000000000000000000000000000000090047f01000000000000000000000000000000000000000000000000000000000000000283838060010194508151811015610000579060200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a9053505b808060010191505061124f565b8296505b50505050505092915050565b600060006000731141d57ea99b8a8ce5faf18774d6dbb56deffc2891508173ffffffffffffffffffffffffffffffffffffffff1663321db4d4600060405160200152604051817c0100000000000000000000000000000000000000000000000000000000028152600401809050602060405180830381600087803b156100005760325a03f115610000575050506040518051906020015090508073ffffffffffffffffffffffffffffffffffffffff1663ed815d8385600060405160200152604051827c010000000000000000000000000000000000000000000000000000000002815260040180806020018281038252838181518152602001915080519060200190808383829060006004602084601f0104600302600f01f150905090810190601f1680156114515780820380516001836020036101000a031916815260200191505b5092505050602060405180830381600087803b156100005760325a03f115610000575050506040518051906020015092505b505091905056";

        class EthRpcRes
        {
            public string JsonRpc { get; set; }
            public int Id { get; set; }
            public string Result { get; set; }
        }

        class BcTransSendContratc
        {
            public string from { get; set; }
            public string to { get; set; }
            public string gas { get; set; }
            public string gasPrice { get; set; }
            public string value { get; set; }
            public string data { get; set; }
        }

        public string SendTransaction(string script)
        {
            try
            {
                using (var client = new SshClient(hostUrl, 22, userName, pass))
                {
                    client.Connect();

                    string filename = Guid.NewGuid().ToString().Substring(0, 5);

                    Func<string, string> toFile = (str) =>
                    {
                        return "echo '" + str.Replace("'", @"'\''") + "' >> ~/eth_data/" + filename;
                    };

                    Func<string, string> toFile2 = (str) =>
                    {
                        return "echo '" + str.Replace("'", @"'\''") + "' >> ~/eth_data/ex" + filename;
                    };

                    SshCommand comm = null;

                    var lines = script.Split(new[] { Environment.NewLine }, StringSplitOptions.RemoveEmptyEntries);

                    foreach (var line in lines)
                    {
                        comm = client.RunCommand(toFile(line));
                    }

                    comm = client.RunCommand($"geth --exec 'loadScript(\"/home/{userName}/eth_data/{filename}\")' attach ipc:chains/devtest/geth.ipc");

                    client.Disconnect();

                    return comm.Result;
                }
            }
            catch (Exception e)
            {
                return string.Empty;
            }
        }

        //public string SendTransaction(TransactionContract tx)
        //{
        //    var result =  SendTransaction("var token = web3.eth.contract([{\"constant\":false,\"inputs\":[{\"name\":\"x\",\"type\":\"address\"}],\"name\":\"toString\",\"outputs\":[{\"name\":\"\",\"type\":\"string\"}],\"payable\":false,\"type\":\"function\"},{\"constant\":true,\"inputs\":[],\"name\":\"response\",\"outputs\":[{\"name\":\"\",\"type\":\"bytes\"}],\"payable\":false,\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"name\":\"id\",\"type\":\"uint256\"},{\"name\":\"_response\",\"type\":\"bytes\"}],\"name\":\"__tinyOracleCallback\",\"outputs\":[],\"payable\":false,\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"name\":\"acc\",\"type\":\"address\"},{\"name\":\"balance\",\"type\":\"uint256\"}],\"name\":\"addAccount\",\"outputs\":[{\"name\":\"balance2\",\"type\":\"uint256\"}],\"payable\":false,\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"name\":\"receiver\",\"type\":\"address\"},{\"name\":\"amount\",\"type\":\"uint256\"},{\"name\":\"callbackUrl\",\"type\":\"string\"}],\"name\":\"sendCoin\",\"outputs\":[{\"name\":\"sufficient\",\"type\":\"bool\"}],\"payable\":false,\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"name\":\"query\",\"type\":\"bytes\"}],\"name\":\"query\",\"outputs\":[],\"payable\":false,\"type\":\"function\"},{\"constant\":false,\"inputs\":[{\"name\":\"acc\",\"type\":\"address\"}],\"name\":\"getAccount\",\"outputs\":[{\"name\":\"balance\",\"type\":\"uint256\"}],\"payable\":false,\"type\":\"function\"},{\"inputs\":[],\"type\":\"constructor\"},{\"anonymous\":false,\"inputs\":[{\"indexed\":false,\"name\":\"sender\",\"type\":\"address\"},{\"indexed\":false,\"name\":\"receiver\",\"type\":\"address\"},{\"indexed\":false,\"name\":\"amount\",\"type\":\"uint256\"}],\"name\":\"CoinTransfer\",\"type\":\"event\"}]).at(\"0xe5855503e18317cfc775cf899f415ae60bce7189\");"+
        //        $"var t = token.sendCoin.sendTransaction(\"{tx.Receiver.BcAccountNumber}\", 2, \"http://ethwebapp.azurewebsites.net/setstatus/{{hash}}\", {{from: \"{tx.Payer.BcAccountNumber}\"}});" + Environment.NewLine +
        //        "console.log(t);" + Environment.NewLine);
        //    tx.TransactionId = result.Split(new[] { '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries).First(s => s.StartsWith("0x"));
        //    IOC.Resolve<IStorageService>().ReceiveTransaction(tx);
        //    return tx.TransactionId;
        //}

        public void CreateDoc(CreateDocContract request)
        {
            //var result = SendTransaction("var token = web3.eth.contract(" + creatorAbiDefinition + ").at(\"" + creatorAddress + "\");" +
            //    $"var t = creator.createTransfer.sendTransaction(\"{request.BicFrom}\", \"{request.BicTo}\", \"{request.DocOriginalId}\", \"{request.DocSerialized}\", {{from: \"eth.accounts[0]\"}});" + Environment.NewLine +
            //    "console.log(t);" + Environment.NewLine);
            //tx.TransactionId = result.Split(new[] { '\r', '\n' }, StringSplitOptions.RemoveEmptyEntries).First(s => s.StartsWith("0x"));

            var str =
@"var urlSender = """ + request.BicFrom + @""";" + Environment.NewLine +
@"var urlReceiver = """ + request.BicTo + @"""; " + Environment.NewLine +
@"var txid = """ + request.DocOriginalId + @"""; " + Environment.NewLine +
@"var json = """ + request.DocSerialized + @"""; " + Environment.NewLine +
@"var trackerContract = web3.eth.contract(" + trackerAbiDefinition + @");" + Environment.NewLine +
"var tracker = trackerContract.new(" +
   "urlSender," +
   "urlReceiver," +
   "txid," +
   "json," +
   "{" +
     "from: web3.eth.accounts[0], " +
     "data: '" + trackerByteCode + "'," +
     "gas: '4700000'" +
   "}, function (e, contract){" +
    "console.log(e, contract);" +
    "if (typeof contract.address !== 'undefined') {" +
         "console.log('Contract mined! address: ' + contract.address + ' transactionHash: ' + contract.transactionHash);" +
    "}" +
" });" + Environment.NewLine;
            str += "admin.sleepBlocks(2);" + Environment.NewLine;
            //str += "tracker.test.sendTransaction({from: eth.accounts[0]});" + Environment.NewLine;
            str += "console.log(tracker);" + Environment.NewLine;

            //str = "eth.accounts[0]" + Environment.NewLine;

            var result = SendTransaction(str);
        }

        public void CloseDeal(CloseDealContract request)
        {
            var result = SendTransaction("var token = web3.eth.contract(" + trackerAbiDefinition + ").at(\"" + request.smartcontractaddr + "\");" +
                $"var t = creator.CloseCreditDeal.sendTransaction({{from: \"eth.accounts[0]\"}});" + Environment.NewLine +
                "console.log(t);" + Environment.NewLine);
        }

        //public void AddBank(AddBankContract request)
        //{
        //    //var result = SendTransaction("var token = web3.eth.contract(" + creatorAbiDefinition + ").at(\"" + creatorAbiDefinition + "\");" +
        //    //    $"var t = creator.AddBank.sendTransaction(\"{request.Bic}\", \"{request.ApiHost}\", {{from: \"eth.accounts[0]\"}});" + Environment.NewLine +
        //    //    "console.log(t);" + Environment.NewLine);
        //}

        //public void DropBank(DropBankContract request)
        //{
        //    //var result = SendTransaction("var token = web3.eth.contract(" + creatorAbiDefinition + ").at(\"" + creatorAbiDefinition + "\");" +
        //    //    $"var t = creator.RemoveBank.sendTransaction(\"{request.Bic}\", {{from: \"eth.accounts[0]\"}});" + Environment.NewLine +
        //    //    "console.log(t);" + Environment.NewLine);
        //}
    }
}
